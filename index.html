<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
  <title>BlueMath Shell</title>
  <link rel='stylesheet', href='/ext/font-awesome.min.css'/>
	<style>
		body {
			overflow:hidden;
		}
		#container {
			min-width: 100px;
		}

		#container > #editor {
			width : 600px;
			height : 100%;
			border: 0px;
			float : left;
		}
		#container > #runtime {
			width : 400px;
			height : 100%;
			margin-left : 600px;
			background : #f8f8f8;
		}
		#container > #runtime > iframe {
			width : 95%;
			height : 80%;
			border: 0px;
		}
		#docholder {
			position : absolute;
			top : 0px;
			height : 0px;
			width : 0px;
		}
		#docholder > #docsclose {
			top : 0px;
			right : 0px;
			position : absolute;
		}

		#btn-panel {
			display : flex;
			justify-content: initial;
		}

		.btn {
			margin-left : 10px;
			margin-right : 10px;
			cursor : pointer;
		}

		.styled-select {
			background: url(http://i62.tinypic.com/15xvbd5.png) no-repeat 96% 0;
			height: 29px;
			overflow: hidden;
			width: 240px;
	   	-webkit-border-radius: 5px;
   		-moz-border-radius: 5px;
   		border-radius: 5px;
			background-color :#4040ff;
		}

		.styled-select select {
			background: transparent;
			border: none;
			font-size: 14px;
			height: 29px;
			padding: 5px; /* If you add too much padding here, the options won't show in IE */
			width: 268px;
			color : white;
		}
	</style>
</head>

<body>
<script src="./ext/FileSaver.min.js"></script>
<script src="./src/examples.js"></script>
<script src="./build/extralibs.js"></script>
<script src="./ext/monaco-editor/min/vs/loader.js"></script>

	<div id="container">
		<div id="editor"></div>
		<div id="runtime"></div>
	</div>
	<br/>
	<div id="btn-panel">
		<div class="styled-select">
			<select id="examples-choices"></select>
		</div>
		<i class="btn fa fa-play fa-2x" id="btn-run" title="Run"></i>
		<i class="btn fa fa-trash fa-2x" id="btn-clear" title="Clear"></i>
		<i class="btn fa fa-save fa-2x" id="btn-save" title="Save"></i>
		<i class="btn fa fa-book fa-2x" id="btn-docs" title="API Docs"></i>
	</div>
	<div id="docholder">
		<i class="btn fa fa-window-close fa-2x" id="docsclose" title="Close"></i>
	</div>

	<script>
		let W = window.innerWidth-10;
		let H = window.innerHeight-10;
		var editor;
		let containerElem = document.getElementById('container');
		let editorElem = document.getElementById('editor');
		let runtimeElem = document.getElementById('runtime');
		let docholderElem = document.getElementById('docholder');
		let docsCloseElem = document.getElementById('docsclose');
		let exmChoices = document.getElementById('examples-choices');
		let clearElem = document.getElementById('btn-clear');
		let saveElem = document.getElementById('btn-save');

		let preambleTypeDeclaration =
		`
		declare function bmlog(...args:any[]) {}
		`

		// Setup Monaco editor
		require.config({ paths: { 'vs': './ext/monaco-editor/min/vs' }});
		require(['vs/editor/editor.main'], function() {
			editor = monaco.editor.create(editorElem, {
				language: 'typescript',
				lineNumbers : false,
				minimap : {
					enabled : false
				}
			});

			// validation settings
			monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({
				noSemanticValidation: true,
				noSyntaxValidation: false
			});

			// compiler options
			monaco.languages.typescript.typescriptDefaults.setCompilerOptions({
				target: monaco.languages.typescript.ScriptTarget.ES6,
				allowNonTsExtensions: true
			});

			// extra libraries
			for(let extralib of EXTRA_LIBS) {
				monaco.languages.typescript.typescriptDefaults.addExtraLib(
					extralib.source, extralib.fpath);
			}
			monaco.languages.typescript.typescriptDefaults.addExtraLib(
				preambleTypeDeclaration);

			// Setup example choices
			let exmKeys = Object.keys(BMSHELL_EXAMPLES);
			for(let key of exmKeys) {
				let opt = document.createElement('option');
				opt.textContent = key;
				exmChoices.appendChild(opt);
			}
			exmChoices.onchange = () => {
				let exmCode = BMSHELL_EXAMPLES[exmChoices.value];
				editor.getModel().setValue(exmCode);
			}
			// Populate with first example
			exmChoices.value = exmKeys[0];
			editor.getModel().setValue(BMSHELL_EXAMPLES[exmKeys[0]]);
		});


		// Recreate the runtime iframe and execute the code each time 'Run'
		// is clicked
		var runbutton = document.querySelector('#btn-run');
		runbutton.onclick = () => {
			let codestring = editor.getModel().getValue();
			let ifrm = runtimeElem.querySelector('iframe');
			if(ifrm) {
				ifrm.remove();
			}
			ifrm = document.createElement('iframe');
			ifrm.setAttribute('src', './runtime.html');
			runtimeElem.appendChild(ifrm);
			ifrm.contentWindow.onload = () => {
				ifrm.contentWindow.eval(codestring);
			}
		};

		let docsButton = document.querySelector('#btn-docs');
		docsButton.onclick = () => {
			let ifrm = document.createElement('iframe');
			ifrm.setAttribute('src', 'http://www.bluemathsoftware.com/docs/index.html');
			ifrm.style.height = '100%';
			ifrm.style.width = '100%';
			docholderElem.insertBefore(ifrm,docsCloseElem);

			docholderElem.style.left = Math.round(0.2*W)+'px';
			docholderElem.style.width = Math.round(0.8*W)+'px';
			docholderElem.style.height = H+'px';
		};

		docsCloseElem.onclick = () => {
			let ifrm = docholderElem.querySelector('iframe');
			ifrm.remove();
			docholderElem.style.left = (W+20)+'px';
		}

		clearElem.onclick = () => {
			if(confirm('Clear the editor? You will loose any unsaved code')) {
				editor.getModel().setValue('');
			}
		}

		saveElem.onclick = () => {
			var blob = new Blob([editor.getModel().getValue()], {type: "text/plain;charset=utf-8"});
			saveAs(blob, 'bluemath-script.ts');
		}

		containerElem.style.width = W+'px';
		containerElem.style.height = Math.round(0.8*H)+'px';
		editorElem.style.width = Math.round(0.6*W)+'px';
		runtimeElem.style.width = Math.round(0.4*W)+'px';
		runtimeElem.style.marginLeft = Math.round(0.6*W)+'px';
	</script>

</body>
</html>
